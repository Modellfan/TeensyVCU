#pragma once
#include <ACAN_T4.h>
#include "crc8_sae_fast.h"   // brings in check_crc8_lookup_fast + extern crc8_table[256]

// ---- User-defined per-ID CRC xorout table (learned) ----
// ---- User-defined per-ID CRC xorout table (learned) ----
static const CrcParams kCrcTable_User_Fast[] = {
  {0x080, 0x05},
  {0x081, 0x60},
  {0x082, 0xCF},
  {0x083, 0xAA},
  {0x084, 0x8C},
  {0x085, 0xE9},
  {0x086, 0x46},
  {0x087, 0x23},
  {0x100, 0xAA},
  {0x101, 0xCF},
  {0x102, 0x60},
  {0x103, 0x05},
  {0x105, 0x46},
  {0x106, 0xE9},
  {0x107, 0x8C},
  {0x120, 0x96},
  {0x121, 0xF3},
  {0x122, 0x5C},
  {0x123, 0x39},
  {0x125, 0x7A},
  {0x126, 0xD5},
  {0x127, 0xB0},
  {0x130, 0x88},
  {0x131, 0xED},
  {0x132, 0x42},
  {0x133, 0x27},
  {0x135, 0x64},
  {0x136, 0xCB},
  {0x137, 0xAE},
  {0x140, 0xD2},
  {0x141, 0xB7},
  {0x142, 0x18},
  {0x143, 0x7D},
  {0x145, 0x3E},
  {0x146, 0x91},
  {0x147, 0xF4},
  {0x150, 0xCC},
  {0x151, 0xA9},
  {0x152, 0x06},
  {0x153, 0x63},
  {0x155, 0x20},
  {0x156, 0x8F},
  {0x157, 0xEA},
  {0x160, 0xEE},
  {0x161, 0x8B},
  {0x162, 0x24},
  {0x163, 0x41},
  {0x165, 0x02},
  {0x166, 0xAD},
  {0x167, 0xC8},
  {0x170, 0xF0},
  {0x171, 0x95},
  {0x172, 0x3A},
  {0x173, 0x5F},
  {0x175, 0x1C},
  {0x176, 0xB3},
  {0x177, 0xD6},
};

// ---- BMW i3 CRC check: fast LUT-based CRC check ----
// If ID is known: validate CRC
// If ID is not listed: skip check (assume no CRC)
static inline bool CRC8BMWi3(const CANMessage& frame) {
  if (frame.rtr) return false;        // No data in RTR frames
  if (frame.len > 8) return false;    // Classic CAN limit

  return check_crc8_lookup_fast(
    frame.id,
    frame.data,
    frame.len,
    kCrcTable_User_Fast,
    sizeof(kCrcTable_User_Fast) / sizeof(kCrcTable_User_Fast[0]),
    0xFF, // SAE-J1850 init (fixed by spec)
    0x1D  // SAE-J1850 poly (ignored here; crc8_table must match)
  );
}

// Backward-compatible alias if other code references the old name.
static inline bool example_function_fast(const CANMessage& frame) {
  return CRC8BMWi3(frame);
}
